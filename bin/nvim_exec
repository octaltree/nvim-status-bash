#!/usr/bin/env bash

# no double quote
LIB=`cat<<EOF
function! _find_nvim(pid) abort
  let xs = glob('/tmp/nvim*/0', v:false, v:true)
  for x in xs
    try
      let c = sockconnect('pipe', x, {'rpc': v:true, 'data_buffered': v:false})
      let p = rpcrequest(c, 'nvim_call_function', 'getpid', [])
      if p == a:pid
        return c
      endif
      call chanclose(c)
    catch /connection failed/
    endtry
  endfor
endfunction
EOF`

function main(){
  cat| nvim --headless -u NONE -\
    -c 'let script = join(getline(1, "$"), "\n")'\
    -c "let pid = $1"\
    -c "call nvim_exec(\"${LIB}\", v:false)"\
    -c 'let c = _find_nvim(pid)'\
    -c 'if c == 0 | cq | endif'\
    -c 'echo rpcrequest(c, "nvim_exec", script, v:true)'\
    -c 'q!'
}

main $*
